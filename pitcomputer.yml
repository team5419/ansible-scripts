#todo: Disable keyboard shortcuts -- figure out keepalive wg
---
- name: Pit Computer Configuration
  hosts: pit

  tasks:
    - name: Set hostname to match inventory
      hostname:
        name: '{{ name }}'

    - name: Update package lists
      become: true
      apt:
        update_cache: yes
        cache_valid_time: 86400

    - name: Install prerequisite software
      become: true
      apt:
        name: 
          - i965-va-driver-shaders
          - mpv
          - firefox-esr
          - wireguard-tools
          - openresolv
          - git
          - pip
          - htop
          - nmon
          - intel-gpu-tools
          - iftop

    - name: Update all packages to their latest version
      become: true
      apt:
        name: "*"
        state: latest

    - name: Install MAPSS prerequisite python packages
      pip:
        name:
          - flask 
          - google-api-python-client 
          - GitPython 
          - configparser

    - name: Install MAPSS
      git:
        repo: 'https://github.com/team5419/MAPSS.git'
        dest: ~/Desktop/MAPSS

    - name: Transfer MAPSS Configuration
      copy:
        src: pitcomputer/MAPSS/
        dest: ~/Desktop/MAPSS

#should use rsync cause large file
    - name: Transfer video files
      copy:
        src: pitcomputer/compDisplay/
        dest: ~/Desktop/

    - name: Transfer autostart Script
      copy:
        src: pitcomputer/startup.sh
        dest: ~/Desktop/startup.sh
        mode: +x

    - name: Transfer autostart Configuration
      copy:
        src: pitcomputer/startup.desktop
        dest: ~/.config/autostart/startup.desktop

    - name: Transfer MPV Configuration
      copy:
        src: pitcomputer/mpv.conf
        dest: ~/.config/mpv/mpv.conf


    - name: Transfer sshd Configuration
      become: true
      copy:
        src: pitcomputer/sshd_config
        dest: /etc/ssh/sshd_config

    - name: Transfer autologin Configuration
      become: true
      copy:
        src: pitcomputer/lightdm.conf
        dest: /etc/lightdm/lightdm.conf

    - name: Transfer grub Configuration
      become: true
      copy:
        src: pitcomputer/grub
        dest: /etc/default/grub

    - name: Transfer wireguard config file
      become: true
      copy:
        src: wireguard/{{ name }}.conf
        dest: /etc/wireguard/team.conf
        owner: root
        group: root
        mode: '0600'

    - name: enable wireguard tunnel
      become: true
      systemd:
        name: wg-quick@team
        state: started
        enabled: yes
